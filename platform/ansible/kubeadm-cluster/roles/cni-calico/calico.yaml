---
- name: Install Calico CNI
  hosts: control_plane
  become: yes
  vars_files:
    - calico-vars.yaml

  tasks:
    - name: Install Tigera operator (CRDs)
      shell: |
        kubectl get crd installations.operator.tigera.io >/dev/null 2>&1 || \
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/tigera-operator.yaml
      environment:
        KUBECONFIG: /root/.kube/config

    - name: Create Calico custom resources
      copy:
        dest: /root/custom-resources.yaml
        content: |
          apiVersion: operator.tigera.io/v1
          kind: Installation
          metadata:
            name: default
          spec:
            calicoNetwork:
              ipPools:
              - name: default-ipv4-ippool
                blockSize: 26
                cidr: {{ pod_cidr }}
                encapsulation: VXLANCrossSubnet
                natOutgoing: Enabled
                nodeSelector: all()
          ---
          apiVersion: operator.tigera.io/v1
          kind: APIServer
          metadata:
            name: default
          spec: {}
      environment:
        KUBECONFIG: /root/.kube/config

    - name: Apply Calico custom resources
      command: kubectl apply -f /root/custom-resources.yaml
      environment:
        KUBECONFIG: /root/.kube/config
